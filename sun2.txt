INSERT INTO DOL_STAGING.IANALYZE_CA_COMMISSIONS_BY_PRODUCT
SELECT X.BD, X.BNS_TRIMED_ACCOUNT_NUMBER, X.ACTUAL_ACCOUT_NUMBER, X.PRODUCT_LINE
, X.CRD_NUMBER
,SUM(X.COMMISSIONS) AS GDC_COMMISSIONS, SUM(X.ADVISORY_FEES) AS GDC_ADVISORY, SUM(X.TRAILS) AS GDC_TRAILS, SUM(X.REVENUE) AS REVENUE
FROM 
(SELECT 
T.BD,
TRIM(REPLACE(REPLACE (ltrim(REPLACE (T.SPONSOR_ACCT_NUMBER,'0',' ')), ' ','0'), '-','')) AS BNS_TRIMED_ACCOUNT_NUMBER,
T.SPONSOR_ACCT_NUMBER AS ACTUAL_ACCOUT_NUMBER,
CASE WHEN P.GROUP_CODE != 'ADV' AND T.A12B1_IND = 'N' THEN  SUM(T.GDC_AMT) ELSE  0 END AS COMMISSIONS,
CASE WHEN P.GROUP_CODE = 'ADV' AND T.A12B1_IND = 'N' THEN SUM(T.GDC_AMT)  ELSE 0 END AS ADVISORY_FEES,
CASE WHEN T.A12B1_IND = 'Y' THEN SUM(T.GDC_AMT) ELSE 0 END AS TRAILS,
SUM(T.GDC_AMT) AS REVENUE,
P.GROUP_CODE,
CASE WHEN T.ACTUAL_CUSIP = ETF.CUSIP THEN  'ETF' ELSE PG.CODE_DESC END AS GROUP_PRODUCT_DESC,
PSG.CODE_DESC AS SUB_GROUP_PRODUCT_DESC,
(CASE 
WHEN PG.CODE_DESC = '529 Plans' THEN 'MUTUAL FUNDS'
WHEN PG.CODE_DESC = 'Advisory' AND PSG.CODE_DESC IN ('3rd Party Separate Acct','3rd Party Timing','3rd Party Wrap Fees','Consulting Services','Fiduciary Services','Financial Plans'
,'Internal Wrap Fees','Lockwood Wrap Fees','Outside RIA Fees','Production Credit') THEN 'ADVISORY'
WHEN PG.CODE_DESC = 'Banking' THEN 'MISCELLANEOUS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC = 'Agency Debt/CMOs' THEN 'TREASURY NOTES/BILLS/CDS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC IN ('Corporate Bonds' ,'Government Bonds','Muni Bonds','OTC Bonds') THEN 'BONDS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC IN ('Listed Stocks','OTC Stocks') THEN 'EQUITIES'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC = 'Options' THEN 'OPTIONS/RIGHTS/WARRANTS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC = 'Other Brokerage' THEN 'MISCELLANEOUS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC =  'Treasury Securities' THEN 'TREASURY NOTES/BILLS/CDS'
WHEN PG.CODE_DESC = 'Brokerage' AND PSG.CODE_DESC = 'UIT' THEN 'UNIT INVESTMENT TRUST'
WHEN PG.CODE_DESC = 'Fixed Ins' AND PSG.CODE_DESC IN ('Disability','Fixed Annuity','Fixed Life','Group Annuity','Life Settlement','Long Term Care','Misc Insurance','Term') THEN 'FIXED INSURANCE'
WHEN PG.CODE_DESC = 'Ltd P`ships' AND PSG.CODE_DESC IN ('Private','Public','REIT') THEN 'LIMITED PARTNERSHIPS'
WHEN PG.CODE_DESC IN ('Miscellaneous','Trust','Wholesale') THEN 'MISCELLANEOUS'
WHEN PG.CODE_DESC = 'Money Market Funds' THEN 'CASH OR EQUIVALENTS'
WHEN PG.CODE_DESC = 'Mutual Funds' THEN 'MUTUAL FUNDS'
WHEN PG.CODE_DESC = 'Offshore Funds' THEN 'MUTUAL FUNDS'
WHEN PG.CODE_DESC IN ('Offshore VA','Variable Annuity') THEN 'VARIABLE ANNUITY'
WHEN PG.CODE_DESC = 'Variable Life' THEN 'VARIABLE UNIVERSAL LIFE'
WHEN T.ACTUAL_CUSIP = ETF.CUSIP THEN  'ETF' ELSE PG.CODE_DESC END) AS PRODUCT_LINE,
R.CRD_NUMBER
FROM
BONUS.TRADES T
LEFT JOIN BONUS.REPS_NUMBERS RN ON T.RNR = RN.REP_NUMBER AND RN.PRIMARY_SSN_IND = 'Y'
INNER JOIN BONUS.REPS R ON RN.SSN = R.SSN
LEFT JOIN BONUS.PRODUCTS P
ON T.PROD_SPON_CODE = P.SPON_CODE 
AND T.PRODUCT_NUMBER = P.PRODUCT_NUMBER
LEFT JOIN BONUS.ETF_CUSIPS ETF 
ON T.ACTUAL_CUSIP = ETF.CUSIP
LEFT JOIN BONUS.PRODUCT_GROUP_CODES PG
ON P.GROUP_CODE = PG.CODE_ID
LEFT JOIN BONUS.PRODUCT_SUB_GROUPS PSG
ON P.SUB_GROUP_CODE = PSG.SUB_GROUP_CODE
WHERE T.PD_DATE BETWEEN ADD_MONTHS(TRUNC(CURRENT_DATE,'MONTH'),-12)  AND LAST_DAY(ADD_MONTHS(CURRENT_DATE,-1))
AND  T.BD = 4
GROUP BY 
T.BD,
T.SPONSOR_ACCT_NUMBER,
T.ACTUAL_CUSIP,
T.A12B1_IND,
P.GROUP_CODE,
PG.CODE_DESC,
PSG.CODE_DESC,
ETF.CUSIP
,R.CRD_NUMBER
) X
GROUP BY X.BD, X.BNS_TRIMED_ACCOUNT_NUMBER, X.ACTUAL_ACCOUT_NUMBER, X.PRODUCT_LINE, X.CRD_NUMBER;
